<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Work Log - Vers√£o Atualizada</title>
  <style>
    /* [Seus estilos atuais aqui] */
    .debug-info {
      background: #f0f0f0;
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <!-- [Seu HTML atual aqui] -->

  <!-- Adicione este bot√£o no footer -->
  <footer class="rodape">
    <!-- [Seus bot√µes atuais] -->
    <button onclick="forceRefresh()" class="btn-atualizar">üîÑ For√ßar Atualiza√ß√£o</button>
  </footer>

<script type="module">
// [Suas importa√ß√µes do Firebase atuais aqui]

// Vers√£o do App - Atualize sempre que fizer mudan√ßas
const APP_VERSION = "2.2.0";

// 1. Verifica√ß√£o Inicial de Cache
async function checkCache() {
  const lastVersion = localStorage.getItem('appVersion');
  
  if (lastVersion !== APP_VERSION) {
    console.log(`Atualizando cache da vers√£o ${lastVersion || 'desconhecida'} para ${APP_VERSION}`);
    await clearProblematicCache();
    localStorage.setItem('appVersion', APP_VERSION);
  }
}

// 2. Limpeza Segura de Cache
async function clearProblematicCache() {
  try {
    // Limpa apenas o cache problem√°tico, mantendo os registros
    const recordsBackup = localStorage.getItem("records");
    const userNameBackup = localStorage.getItem("userName");
    
    // Limpeza seletiva
    localStorage.removeItem("appVersion");
    caches.keys().then(names => names.forEach(name => caches.delete(name)));
    
    // Restaura os dados importantes
    if (recordsBackup) localStorage.setItem("records", recordsBackup);
    if (userNameBackup) localStorage.setItem("userName", userNameBackup);
    
    console.log("Cache limpo com seguran√ßa");
  } catch (error) {
    console.error("Erro ao limpar cache:", error);
  }
}

// 3. Fun√ß√£o para For√ßar Atualiza√ß√£o
window.forceRefresh = async function() {
  if (confirm("‚ö†Ô∏è Isso ir√°:\n\n1. Limpar o cache do navegador\n2. Recarregar todos os dados do Firebase\n\nDados existentes N√ÉO ser√£o perdidos.\n\nContinuar?")) {
    try {
      // Mostra feedback visual
      const btn = event.target;
      btn.innerHTML = "‚åõ Processando...";
      btn.disabled = true;
      
      // Executa a limpeza
      await clearProblematicCache();
      
      // Sincroniza com Firestore
      await syncWithFirestore();
      
      alert("‚úÖ Atualiza√ß√£o conclu√≠da!\nO app ser√° recarregado.");
      setTimeout(() => location.reload(), 1000);
    } catch (error) {
      console.error("Erro na atualiza√ß√£o:", error);
      alert(`‚ùå Erro: ${error.message}`);
      event.target.innerHTML = "üîÑ For√ßar Atualiza√ß√£o";
      event.target.disabled = false;
    }
  }
};

// 4. Sincroniza√ß√£o Segura com Firestore
async function syncWithFirestore() {
  try {
    const querySnapshot = await getDocs(collection(db, "registros"));
    const firestoreRecords = [];
    
    querySnapshot.forEach(doc => {
      firestoreRecords.push({ ...doc.data(), id: doc.id });
    });

    // Mescla registros existentes com os do Firestore
    const localRecords = JSON.parse(localStorage.getItem("records") || [];
    const mergedRecords = [...localRecords];
    
    firestoreRecords.forEach(fr => {
      if (!mergedRecords.some(lr => lr.id === fr.id)) {
        mergedRecords.push(fr);
      }
    });

    // Atualiza apenas se houver diferen√ßas
    if (mergedRecords.length !== localRecords.length) {
      localStorage.setItem("records", JSON.stringify(mergedRecords));
      records = mergedRecords;
      showRecords();
      console.log(`Sincronizados ${mergedRecords.length - localRecords.length} novos registros`);
    }
  } catch (error) {
    console.error("Erro na sincroniza√ß√£o:", error);
    throw new Error("Falha ao sincronizar com o servidor");
  }
}

// 5. Inicializa√ß√£o Segura
async function initializeApp() {
  await checkCache();
  
  // Verifica dados corrompidos
  try {
    JSON.parse(localStorage.getItem("records"));
  } catch {
    localStorage.removeItem("records");
    console.warn("Dados locais corrompidos - Resetados");
  }
  
  // Carrega dados
  const userName = localStorage.getItem("userName");
  if (!userName) {
    document.getElementById("nameModal").style.display = "flex";
  } else {
    document.getElementById("userDisplay").textContent = `User: ${userName}`;
  }
  
  // Sincroniza com Firestore
  await syncWithFirestore();
  showRecords();
}

// [Seu c√≥digo restante aqui...]

// Inicializa o app
initializeApp().catch(error => {
  console.error("Falha na inicializa√ß√£o:", error);
  alert(`Erro cr√≠tico: ${error.message}\n\nTente limpar o cache manualmente.`);
});

</script>
</body>
</html>
